<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quick Collector â€” Rewired</title>
  <style>
    :root{--card-bg:rgba(255,255,255,0.88);--muted:#64748b;--accent:#06b6d4}
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px;
      background:
        linear-gradient(180deg, rgba(7,10,25,0.18), rgba(7,10,25,0.18)),
        url('https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=2100&q=80') no-repeat center/cover fixed;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .card{width:100%;max-width:720px;background:var(--card-bg);backdrop-filter:blur(6px);border-radius:14px;padding:22px;box-shadow:0 12px 40px rgba(2,6,23,0.18);color:#04202a}
    h1{margin:0 0 6px;font-size:1.25rem}
    p{margin:0 0 14px;color:var(--muted)}
    .row{display:flex;gap:12px}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--accent);color:white}
    .btn-ghost{background:transparent;border:1px solid rgba(2,6,23,0.06);color:#062023}
    input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin-top:8px}
    .hidden{display:none}
    textarea{width:100%;height:140px;padding:10px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin-top:10px}
    .note{font-size:0.95rem;color:var(--muted);margin-top:10px}
    .center{display:flex;justify-content:center}
    footer.small{font-size:0.85rem;color:var(--muted);margin-top:10px;text-align:center}
  </style>
</head>
<body>
  <!-- choose -->
  <main class="card" id="viewChoose">
    <h1>Quick check</h1>
    <p>Pick how you identify to continue.</p>

    <div class="row" style="margin-bottom:12px">
      <button id="girlBtn" class="btn-primary" style="flex:1">Girl</button>
      <button id="boyBtn" class="btn-ghost" style="flex:1">Boy</button>
    </div>

    <p class="note small">bonus joke: ek baar ek raja fakeer ko bolta hai ae gareebðŸ˜­ðŸ˜­ðŸ˜­ðŸ˜­ðŸ˜­ðŸ˜‚ðŸ˜‚ðŸ˜‚ðŸ˜‚ðŸ˜‚ðŸ˜‚
      kitna funny joke hai yawwr ye ðŸ˜­ðŸ˜­ðŸ˜‚ðŸ˜‚ðŸ˜‚ðŸ˜‚ðŸ˜‚
    </p>

    <div style="margin-top:18px">
      <label class="note">Owner actions</label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="openAdmin" class="btn-ghost">Open admin</button>
      </div>
    </div>
    <footer class="small">Tip: Admin requires a password.</footer>
  </main>

  <!-- name -->
  <section class="card hidden" id="viewName">
    <h1>Tell me your name</h1>
    <p class="note">This helps the owner know who submitted.</p>
    <input id="inputName" placeholder="Type your name" autocomplete="off" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="nameNext" class="btn-primary">Next</button>
      <button id="nameBack" class="btn-ghost">Back</button>
    </div>
  </section>

  <!-- id -->
  <section class="card hidden" id="viewID">
    <h1>Social ID</h1>
    <p class="note">Add Insta or Snap username (no @ needed).</p>
    <input id="inputID" placeholder="your_insta_or_snap" autocomplete="off" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="submitAll" class="btn-primary">Submit</button>
      <button id="idBack" class="btn-ghost">Back</button>
    </div>
  </section>

  <!-- goodbye for girls -->
  <section class="card hidden" id="goodbyePage">
    <h1>Goodbye sweetie ðŸ’•</h1>
    <p class="note">Your data has been submitted. Thanks!</p>
  </section>

  <!-- done for boys -->
  <section class="card hidden" id="boyDone">
    <h1>You're king ðŸ‘‘</h1>
    <p class="note">Always follow your passion!</p>
  </section>

  <!-- admin (password protected) -->
  <section class="card hidden" id="adminPanel">
    <h1>Admin panel</h1>
    <p class="note">View, download, or copy submissions.</p>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="viewEntries" class="btn-primary">Show entries</button>
      <button id="downloadCSV" class="btn-ghost">Download CSV</button>
      <button id="copyClip" class="btn-ghost">Copy to clipboard</button>
    </div>

    <div style="margin-top:12px">
      <textarea id="entriesArea" readonly placeholder="Entries will appear here"></textarea>
    </div>

    <div id="adminClearWrap" style="display:flex;gap:8px;margin-top:10px">
      <button id="clearAllAdmin" class="btn-ghost">Clear all data (local only)</button>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="closeAdmin" class="btn-ghost">Close</button>
    </div>
  </section>

  <script>
    // ---- CONFIG: set this to your public server URL from ngrok or your domain ----
    const SERVER_URL = 'https://REPLACE_WITH_YOUR_NGROK_OR_DOMAIN'; // example: https://abc12345.ngrok.io
    // admin token: when you start the server use ADMIN_TOKEN=supersecret123 node server.js
    // you'll type the same token when prompted in the admin UI

    // elements
    const viewChoose = document.getElementById('viewChoose');
    const viewName = document.getElementById('viewName');
    const viewID = document.getElementById('viewID');
    const goodbyePage = document.getElementById('goodbyePage');
    const boyDone = document.getElementById('boyDone');
    const adminPanel = document.getElementById('adminPanel');

    const girlBtn = document.getElementById('girlBtn');
    const boyBtn = document.getElementById('boyBtn');
    const nameNext = document.getElementById('nameNext');
    const nameBack = document.getElementById('nameBack');
    const idBack = document.getElementById('idBack');
    const submitAll = document.getElementById('submitAll');
    const inputName = document.getElementById('inputName');
    const inputID = document.getElementById('inputID');

    const openAdmin = document.getElementById('openAdmin');
    const adminEntries = document.getElementById('viewEntries');
    const entriesArea = document.getElementById('entriesArea');
    const downloadCSV = document.getElementById('downloadCSV');
    const copyClip = document.getElementById('copyClip');
    const closeAdmin = document.getElementById('closeAdmin');
    const clearAllAdmin = document.getElementById('clearAllAdmin');

    // state
    let currentGender = null;
    const KEY = 'quick_collector_entries_v1';

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    function saveSubmission(entry){
      const raw = localStorage.getItem(KEY);
      const arr = raw ? JSON.parse(raw) : [];
      arr.push(entry);
      localStorage.setItem(KEY, JSON.stringify(arr));
    }
    function getEntries(){ const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : []; }

    function entriesToText(arr){
      if(!arr.length) return 'No entries yet.';
      return arr.map(a => `[${a.t}] ${a.gender} | name: ${a.name || '-'} | id: ${a.id || '-'}`).join('\n');
    }
    function entriesToCSV(arr){
      const header = ['timestamp','gender','name','id'];
      const rows = arr.map(a => [a.t, a.gender, `"${(a.name||'').replace(/"/g,'""')}"`, `"${(a.id||'').replace(/"/g,'""')}"`]);
      return [header.join(','), ...rows.map(r=>r.join(','))].join('\n');
    }

    // buttons click feedback
    ['girlBtn','boyBtn','nameNext','nameBack','submitAll','idBack','openAdmin','viewEntries','downloadCSV','copyClip','closeAdmin','clearAllAdmin'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener('click', ()=>console.log('CLICK:', id));
    });

    // wiring
    girlBtn.addEventListener('click', ()=>{
      currentGender = 'Girl';
      inputName.value = '';
      inputID.value = '';
      hideAllScreens();
      show(viewName);
      inputName.focus();
    });

    boyBtn.addEventListener('click', ()=>{
      currentGender = 'Boy';
      inputName.value = '';
      inputID.value = '';
      hideAllScreens();
      show(viewName);
      inputName.focus();
    });

    nameBack.addEventListener('click', ()=>{
      hideAllScreens();
      show(viewChoose);
    });

    idBack.addEventListener('click', ()=>{
      hideAllScreens();
      show(viewName);
    });

    nameNext.addEventListener('click', ()=>{
      const name = inputName.value.trim();
      sessionStorage.setItem('qc_name', name);
      hideAllScreens();
      show(viewID);
      inputID.focus();
    });

    // -------- submit sends to your server; falls back to localStorage if network fails -----
    submitAll.addEventListener('click', async ()=>{
      const id = inputID.value.trim();
      const name = sessionStorage.getItem('qc_name') || '';
      const entry = { t: new Date().toISOString(), gender: currentGender, name, id };

      // Try send to server
      try {
        if (!SERVER_URL || SERVER_URL.includes('REPLACE_WITH')) throw new Error('SERVER_URL not set');
        const res = await fetch(`${SERVER_URL}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(entry)
        });
        if (!res.ok) throw new Error('server returned ' + res.status);
        console.log('Sent to server ok');
      } catch (err) {
        console.warn('Failed to send to server, saving locally:', err);
        saveSubmission(entry);
      }

      // clear session & form
      sessionStorage.removeItem('qc_name');
      inputID.value = '';
      inputName.value = '';

      // final page
      hideAllScreens();
      if(currentGender === 'Girl') show(goodbyePage); else show(boyDone);
    });

    // Admin: prompt for token and call server /entries
    openAdmin.addEventListener('click', async ()=>{
      const token = prompt('Enter admin token:'); // type the same token you set in server env
      if (!token) return;

      // try server first
      try {
        if (!SERVER_URL || SERVER_URL.includes('REPLACE_WITH')) throw new Error('SERVER_URL not set');
        const res = await fetch(`${SERVER_URL}/entries`, {
          headers: { 'X-Admin-Token': token }
        });
        if (!res.ok) throw new Error('server denied ' + res.status);
        const arr = await res.json();
        entriesArea.value = arr.length ? arr.map(a => `[${a.t}] ${a.gender} | ${a.name} | ${a.id} | ${a.remoteIP||'-'}`).join('\n') : 'No entries from server.';
        hideAllScreens();
        show(adminPanel);
        return;
      } catch(err){
        console.warn('Server entries fetch failed:', err);
      }

      // fallback: show local entries
      hideAllScreens();
      show(adminPanel);
      entriesArea.value = entriesToText(getEntries());
    });

    closeAdmin.addEventListener('click', ()=>{
      hideAllScreens();
      show(viewChoose);
    });

    adminEntries.addEventListener('click', async ()=>{
      const token = prompt('Enter admin token to fetch live entries (or Cancel to show local):');
      if(token){
        try {
          const res = await fetch(`${SERVER_URL}/entries`, { headers: { 'X-Admin-Token': token }});
          if (!res.ok) throw new Error('server denied ' + res.status);
          const arr = await res.json();
          entriesArea.value = arr.length ? arr.map(a => `[${a.t}] ${a.gender} | ${a.name} | ${a.id} | ${a.remoteIP||'-'}`).join('\n') : 'No entries from server.';
          return;
        } catch(e){
          alert('Failed to fetch from server. Showing local entries.');
          console.warn(e);
        }
      }
      // show local entries if token not given or fetch failed
      entriesArea.value = entriesToText(getEntries());
    });

    downloadCSV.addEventListener('click', async ()=>{
      const token = prompt('Enter admin token to download CSV from server (or Cancel to download local CSV):');
      if(token){
        try {
          const res = await fetch(`${SERVER_URL}/download.csv`, { headers: { 'X-Admin-Token': token }});
          if (!res.ok) throw new Error('server denied ' + res.status);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'entries.csv';
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          return;
        } catch(e){
          alert('Server download failed. Will try local CSV.');
          console.warn(e);
        }
      }
      // local CSV fallback
      const csv = entriesToCSV(getEntries());
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'entries_local.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    copyClip.addEventListener('click', async ()=>{
      const txt = entriesArea.value || entriesToText(getEntries());
      try {
        await navigator.clipboard.writeText(txt);
        alert('Copied to clipboard');
      } catch(e) {
        alert('Unable to copy (browser blocked) â€” copy manually.');
      }
    });

    clearAllAdmin.addEventListener('click', ()=>{
      if (!confirm('Clear local saved entries? This only clears localStorage, not server data.')) return;
      localStorage.removeItem(KEY);
      entriesArea.value = 'No entries yet.';
      alert('Cleared local entries.');
    });

    function hideAllScreens(){
      hide(viewChoose); hide(viewName); hide(viewID); hide(goodbyePage); hide(boyDone); hide(adminPanel);
    }

    // init
    hideAllScreens();
    show(viewChoose);
  </script>
</body>
</html>

