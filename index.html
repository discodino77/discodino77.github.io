<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quick Collector â€” Rewired</title>
  <style>
    :root{--card-bg:rgba(255,255,255,0.92);--muted:#64748b;--accent:#06b6d4}
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px;
      background:
        linear-gradient(180deg, rgba(7,10,25,0.18), rgba(7,10,25,0.18)),
        url('https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=2100&q=80') no-repeat center/cover fixed;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .card{width:100%;max-width:720px;background:var(--card-bg);backdrop-filter:blur(6px);border-radius:14px;padding:22px;box-shadow:0 12px 40px rgba(2,6,23,0.18);color:#04202a}
    h1{margin:0 0 6px;font-size:1.25rem}
    p{margin:0 0 14px;color:var(--muted)}
    .row{display:flex;gap:12px}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--accent);color:white}
    .btn-ghost{background:transparent;border:1px solid rgba(2,6,23,0.06);color:#062023}
    input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin-top:8px}
    .hidden{display:none}
    textarea{width:100%;height:140px;padding:10px;border-radius:8px;border:1px solid rgba(2,6,23,0.06);margin-top:10px;white-space:pre-wrap}
    .note{font-size:0.95rem;color:var(--muted);margin-top:10px}
    .center{display:flex;justify-content:center}
    footer.small{font-size:0.85rem;color:var(--muted);margin-top:10px;text-align:center}
    .muted{color:var(--muted);font-size:0.92rem}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#04202a;color:white;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.3);display:none}
    .disabled{opacity:0.6;pointer-events:none}
    .small-btn{padding:8px 10px;border-radius:8px;font-weight:600}
  </style>
</head>
<body>
  <!-- choose -->
  <main class="card" id="viewChoose">
    <h1>Quick check</h1>
    <p class="muted">Pick how you identify to continue.</p>

    <div class="row" style="margin-bottom:12px">
      <button id="girlBtn" class="btn-primary" style="flex:1">Girl</button>
      <button id="boyBtn" class="btn-ghost" style="flex:1">Boy</button>
    </div>

    <p class="note">Bonus joke: ek baar ek raja fakeer ko bolta hai ae gareeb â€” vibe check ðŸ˜‚</p>

    <div style="margin-top:18px">
      <label class="note">Owner actions</label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="openAdmin" class="btn-ghost small-btn">Open admin</button>
      </div>
    </div>
    <footer class="small">Tip: Admin requires a token (set on the server). Donâ€™t store secrets in client JS.</footer>
  </main>

  <!-- name -->
  <section class="card hidden" id="viewName">
    <h1>Tell me your name</h1>
    <p class="note">This helps the owner know who submitted.</p>
    <input id="inputName" placeholder="Type your name" autocomplete="off" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="nameNext" class="btn-primary">Next</button>
      <button id="nameBack" class="btn-ghost">Back</button>
    </div>
  </section>

  <!-- id -->
  <section class="card hidden" id="viewID">
    <h1>Social ID</h1>
    <p class="note">Add Insta or Snap username (no @ needed).</p>
    <input id="inputID" placeholder="your_insta_or_snap" autocomplete="off" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="submitAll" class="btn-primary">Submit</button>
      <button id="idBack" class="btn-ghost">Back</button>
    </div>
  </section>

  <!-- goodbye for girls -->
  <section class="card hidden" id="goodbyePage">
    <h1>Goodbye sweetie ðŸ’•</h1>
    <p class="note">Your data has been submitted. Thanks!</p>
  </section>

  <!-- done for boys -->
  <section class="card hidden" id="boyDone">
    <h1>You're king ðŸ‘‘</h1>
    <p class="note">Always follow your passion!</p>
  </section>

  <!-- admin (password protected) -->
  <section class="card hidden" id="adminPanel">
    <h1>Admin panel</h1>
    <p class="note">View, download, or copy submissions.</p>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="viewEntries" class="btn-primary">Show entries</button>
      <button id="downloadCSV" class="btn-ghost">Download CSV</button>
      <button id="copyClip" class="btn-ghost">Copy to clipboard</button>
    </div>

    <div style="margin-top:12px">
      <textarea id="entriesArea" readonly placeholder="Entries will appear here"></textarea>
    </div>

    <div id="adminClearWrap" style="display:flex;gap:8px;margin-top:10px">
      <button id="clearAllAdmin" class="btn-ghost">Clear local data</button>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="closeAdmin" class="btn-ghost">Close</button>
    </div>
  </section>

  <div id="toast" class="toast"></div>

  <script>
    // ===== CONFIG - replace with your public server URL (ngrok or real domain) =====
    const SERVER_URL = "https://specifiable-praepostorial-julee.ngrok-free.dev"; // â† replace with your ngrok HTTPS URL
    // =================================================================================

    // elements
    const viewChoose = document.getElementById('viewChoose');
    const viewName = document.getElementById('viewName');
    const viewID = document.getElementById('viewID');
    const goodbyePage = document.getElementById('goodbyePage');
    const boyDone = document.getElementById('boyDone');
    const adminPanel = document.getElementById('adminPanel');

    const girlBtn = document.getElementById('girlBtn');
    const boyBtn = document.getElementById('boyBtn');
    const nameNext = document.getElementById('nameNext');
    const nameBack = document.getElementById('nameBack');
    const idBack = document.getElementById('idBack');
    const submitAll = document.getElementById('submitAll');
    const inputName = document.getElementById('inputName');
    const inputID = document.getElementById('inputID');

    const openAdmin = document.getElementById('openAdmin');
    const adminEntries = document.getElementById('viewEntries');
    const entriesArea = document.getElementById('entriesArea');
    const downloadCSV = document.getElementById('downloadCSV');
    const copyClip = document.getElementById('copyClip');
    const closeAdmin = document.getElementById('closeAdmin');
    const clearAllAdmin = document.getElementById('clearAllAdmin');

    const toastEl = document.getElementById('toast');

    // state
    let currentGender = null;
    const KEY = 'quick_collector_entries_v1';

    // helpers
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function toast(msg, time=2500){
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(()=> toastEl.style.display = 'none', time);
    }

    function saveLocal(entry){
      const raw = localStorage.getItem(KEY);
      const arr = raw ? JSON.parse(raw) : [];
      arr.push(entry);
      localStorage.setItem(KEY, JSON.stringify(arr));
    }
    function getLocal(){ const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : []; }

    function entriesToText(arr){
      if(!arr.length) return 'No entries yet.';
      return arr.map(a => `[${a.t}] ${a.gender} | name: ${a.name || '-'} | id: ${a.id || '-'} | ip: ${a.remoteIP||'-'}`).join('\n\n');
    }
    function entriesToCSV(arr){
      const header = ['timestamp','gender','name','id','remoteIP'];
      const rows = arr.map(a => [a.t, a.gender, (a.name||'').replace(/"/g,'""'), (a.id||'').replace(/"/g,'""'), a.remoteIP||'']);
      return [header.join(','), ...rows.map(r=>r.map(field => `"${String(field).replace(/"/g,'""')}"`).join(','))].join('\n');
    }

    // UX feedback logging for dev
    ['girlBtn','boyBtn','nameNext','nameBack','submitAll','idBack','openAdmin','viewEntries','downloadCSV','copyClip','closeAdmin','clearAllAdmin'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener('click', ()=>console.log('CLICK:', id));
    });

    // navigation wiring
    girlBtn.addEventListener('click', ()=> { currentGender = 'Girl'; inputName.value=''; inputID.value=''; hideAllScreens(); show(viewName); inputName.focus(); });
    boyBtn.addEventListener('click', ()=> { currentGender = 'Boy'; inputName.value=''; inputID.value=''; hideAllScreens(); show(viewName); inputName.focus(); });

    nameBack.addEventListener('click', ()=> { hideAllScreens(); show(viewChoose); });
    idBack.addEventListener('click', ()=> { hideAllScreens(); show(viewName); });

    nameNext.addEventListener('click', ()=> {
      const name = inputName.value.trim();
      sessionStorage.setItem('qc_name', name);
      hideAllScreens();
      show(viewID);
      inputID.focus();
    });

    // submit handler: try POST to server, fallback to local
    submitAll.addEventListener('click', async ()=>{
      submitAll.classList.add('disabled');
      const id = inputID.value.trim();
      const name = (sessionStorage.getItem('qc_name') || '').trim();
      const entry = { t: new Date().toISOString(), gender: currentGender, name, id };

      // attempt to send to server
      let sentToServer = false;
      if (SERVER_URL && !SERVER_URL.includes('REPLACE_WITH')) {
        try {
          const controller = new AbortController();
          const timeout = setTimeout(()=>controller.abort(), 8000); // 8s timeout
          const res = await fetch(`${SERVER_URL.replace(/\/$/,'')}/submit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entry),
            signal: controller.signal
          });
          clearTimeout(timeout);
          if(res.ok){
            sentToServer = true;
            toast('Sent to server âœ¨');
          } else {
            console.warn('Server returned', res.status);
            toast('Server rejected submission â€” saved locally');
          }
        } catch (err) {
          console.warn('Network/send error:', err);
          toast('Could not reach server â€” saved locally');
        }
      } else {
        toast('Server URL not set â€” saved locally');
      }

      if (!sentToServer) {
        saveLocal(entry);
      }

      // cleanup UI
      sessionStorage.removeItem('qc_name');
      inputID.value = '';
      inputName.value = '';
      submitAll.classList.remove('disabled');

      hideAllScreens();
      if(currentGender === 'Girl') show(goodbyePage); else show(boyDone);
    });

    // Admin: open panel and try to fetch live entries with token; fallback to local storage
    openAdmin.addEventListener('click', async ()=>{
      const token = prompt('Enter admin token (server token):');
      if (!token) return;

      // try server first
      if (SERVER_URL && !SERVER_URL.includes('REPLACE_WITH')) {
        try {
          const res = await fetch(`${SERVER_URL.replace(/\/$/,'')}/entries`, {
            headers: { 'X-Admin-Token': token }
          });
          if (res.ok){
            const arr = await res.json();
            entriesArea.value = entriesToText(arr);
            hideAllScreens();
            show(adminPanel);
            return;
          } else {
            alert('Server denied access or returned error. Showing local entries.');
          }
        } catch (e) {
          console.warn('Admin fetch failed:', e);
          alert('Could not reach server. Showing local entries.');
        }
      } else {
        alert('Server URL not configured â€” showing local entries.');
      }

      // fallback: local
      entriesArea.value = entriesToText(getLocal());
      hideAllScreens();
      show(adminPanel);
    });

    adminEntries.addEventListener('click', async ()=> {
      const token = prompt('Enter admin token (Cancel to view local):');
      if (token && SERVER_URL && !SERVER_URL.includes('REPLACE_WITH')) {
        try {
          const res = await fetch(`${SERVER_URL.replace(/\/$/,'')}/entries`, { headers: { 'X-Admin-Token': token }});
          if (res.ok) {
            const arr = await res.json();
            entriesArea.value = entriesToText(arr);
            return;
          } else {
            alert('Server returned error â€” showing local.');
          }
        } catch(e){
          console.warn(e);
          alert('Failed to fetch from server â€” showing local.');
        }
      }
      entriesArea.value = entriesToText(getLocal());
    });

    downloadCSV.addEventListener('click', async ()=>{
      const token = prompt('Enter admin token to download server CSV (Cancel for local):');
      if (token && SERVER_URL && !SERVER_URL.includes('REPLACE_WITH')) {
        try {
          const res = await fetch(`${SERVER_URL.replace(/\/$/,'')}/download.csv`, { headers: { 'X-Admin-Token': token }});
          if (res.ok) {
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'entries.csv';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
            return;
          } else {
            alert('Server denied CSV. Falling back to local CSV.');
          }
        } catch (e) {
          console.warn(e);
          alert('Failed server download. Falling back to local CSV.');
        }
      }
      // local CSV
      const csv = entriesToCSV(getLocal());
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'entries_local.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    copyClip.addEventListener('click', async ()=>{
      const txt = entriesArea.value || entriesToText(getLocal());
      try { await navigator.clipboard.writeText(txt); toast('Copied to clipboard ðŸ‘'); }
      catch(e){ alert('Unable to copy. Select and copy manually.'); }
    });

    clearAllAdmin.addEventListener('click', ()=>{
      if (!confirm('Clear local saved entries? This only removes localStorage, not server data.')) return;
      localStorage.removeItem(KEY);
      entriesArea.value = 'No entries yet.';
      toast('Local entries cleared');
    });

    closeAdmin.addEventListener('click', ()=>{
      hideAllScreens();
      show(viewChoose);
    });

    function hideAllScreens(){
      hide(viewChoose); hide(viewName); hide(viewID); hide(goodbyePage); hide(boyDone); hide(adminPanel);
    }

    // init
    hideAllScreens();
    show(viewChoose);
  </script>
</body>
</html>

